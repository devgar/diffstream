<!DOCTYPE html>
<html>

<head>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism.css" rel="stylesheet" />
  <script>
    window.Prism = window.Prism || {};
    Prism.manual = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <title>Visual Studio Show!</title>
  <script type="module">
    import * as monaco from './modules/monaco-editor/esm/vs/editor/editor.main.js';

self.MonacoEnvironment = {
	getWorkerUrl: function (moduleId, label) {
		if (label === 'json') {
			return './json.worker.js';
		}
		if (label === 'css' || label === 'scss' || label === 'less') {
			return './css.worker.js';
		}
		if (label === 'html' || label === 'handlebars' || label === 'razor') {
			return './html.worker.js';
		}
		if (label === 'typescript' || label === 'javascript') {
			return './ts.worker.js';
		}
		return './editor.worker.js';
	}
};

const mod = document.createElement('div')

monaco.editor.create(mod, {
	value: ['function x() {', '\tconsole.log("Hello world!");', '}'].join('\n'),
	language: 'javascript'
});
  </script>
</head>

<body><!--
--><pre><code class="language-css"></code></pre><!--
  --><script>
    function render (content, language) {
      if (!Prism.languages[language]) {
        Prism.plugins.autoloader.loadLanguages('markdown', function () {
          if (!Prism.languages[language]) {
            CODE.innerText = content
            CODE.className = `language-none`
          } else {
            CODE.innerHTML = Prism.highlight(content, Prism.languages[language], language)
            CODE.className = `language-${language}`    
          }
        })
      } else {
        CODE.innerHTML = Prism.highlight(content, Prism.languages[language], language)
        CODE.className = `language-${language}`
      }
        
    }
    const CODE = document.querySelector('code');
    const eventSource = new EventSource("/stream");
    let __DOC = {};
    eventSource.onmessage = function(e) {
      console.log('Unhandled Message:', e.data);
    };
    eventSource.onerror = function(e) {
      console.error(e);
    };
    eventSource.addEventListener('ping', (e) => console.log('ping', e.data) );

    eventSource.addEventListener('initial', (e) => {
      __DOC = JSON.parse(e.data)
      const { language, content } = __DOC
      render(content, language)
    });
    
    eventSource.addEventListener('changeTextDocument', (e) => {
      const data = JSON.parse(e.data)
      window.LASTDATA = data // DEBUG
      if (data.document.fileName !== __DOC.fileName) return
      if (!data.contentChanges.length) return;
      // TODO: Instead of rewritting edit using contentChanges
      // const eol = data.document.eol == 2 ? '\r\n' : '\n'
      const language = data.document.languageId
      __DOC.content = data.content
      if (Prism.languages[language]) 
        CODE.innerText = Prism.highlight(data.content,  Prism.languages[language], language)
      else
        CODE.innerText = data.content
    });

    eventSource.addEventListener('changeActiveTextEditor', (e) => {
      const data = JSON.parse(e.data)
      if (!data.textEditor) {
        __DOC = {}
        render("", "")
        return
      }
      const { content } = data
      const { fileName, languageId: language } = data.textEditor.document
      __DOC = { content, fileName, language }
      render(content, language)
    });

    eventSource.addEventListener('changeTextEditorVisibleRanges', (e) => {
      console.log('changeTextEditorVisibleRanges', e.data)
    });
  </script><!--
  --></body>

</html>